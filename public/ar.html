<!DOCTYPE html>
<html lang="sl">
  <head>
    <meta charset="UTF-8" />
    <title>RealDropHunt Move – AR prevzem</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <!-- A-Frame + MindAR samo za kamero -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        background: #000;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        color: #f5f7ff;
      }

      .ar-overlay {
        position: fixed;
        inset: 0;
        z-index: 1;
        display: flex;
        flex-direction: column;
      }

      a-scene {
        width: 100%;
        height: 100%;
      }

      .ar-topbar {
        position: absolute;
        top: 8px;
        left: 0;
        right: 0;
        z-index: 10;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        pointer-events: none;
      }

      .ar-btn {
        pointer-events: auto;
        border: none;
        border-radius: 999px;
        padding: 6px 12px;
        font-size: 13px;
        background: rgba(10, 10, 10, 0.8);
        color: #f5f7ff;
        backdrop-filter: blur(10px);
        cursor: pointer;
      }

      .ar-title {
        font-size: 14px;
        opacity: 0.85;
      }

      .ar-bottom {
        position: absolute;
        bottom: 10px;
        left: 0;
        right: 0;
        text-align: center;
        padding: 6px 12px;
        font-size: 13px;
        opacity: 0.9;
        pointer-events: none;
      }

      .toast {
        position: absolute;
        left: 50%;
        bottom: 80px;
        transform: translateX(-50%);
        background: rgba(10, 10, 10, 0.8);
        color: #f5f7ff;
        padding: 8px 12px;
        border-radius: 999px;
        font-size: 13px;
        opacity: 0;
        transition: opacity 0.25s ease-out;
        pointer-events: none;
      }

      .toast.show {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <div class="ar-overlay">
      <div class="ar-topbar">
        <!-- ZAPRI: zdaj preko JS (history.back ali moveapp) -->
        <button class="ar-btn" id="btnClose">✕ Zapri</button>
        <span class="ar-title" id="titleLabel">Move • AR prevzem</span>
      </div>

      <!-- AR SCENE
           MindAR tukaj samo za kamero (imageTargetSrc mora obstajat,
           ampak markerja ne uporabljamo – pin je vedno pred kamero) -->
      <a-scene
        mindar-image="imageTargetSrc: ./mind/targets.mind; autoStart: true; uiError: no; uiScanning: no; uiLoading: yes;"
        embedded
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: true"
        renderer="colorManagement: true; physicallyCorrectLights: true"
      >
        <!-- CAMERA z cursorjem za tap na ekran (POPRAVLJENO: cursor direktno na kameri) -->
        <a-entity
          camera
          look-controls="enabled: true"
          cursor="fuse: false; rayOrigin: mouse"
          raycaster="objects: .clickable"
        >
        </a-entity>

        <!-- ASSETS -->
        <a-assets>
          <a-asset-item
            id="neonPinModel"
            src="./models/neon-pin.glb"
          ></a-asset-item>
        </a-assets>

        <!-- 3D PIN – vedno ~1m pred kamero -->
        <a-entity
          id="claim-pin"
          class="clickable"
          gltf-model="#neonPinModel"
          position="0 -0.15 -1"
          rotation="0 0 0"
          scale="0.35 0.35 0.35"
          animation__idle="property: position; dir: alternate; to: 0 0.05 -1; loop: true; dur: 1200; easing: easeInOutSine"
          animation__claim="property: scale; from: 0.35 0.35 0.35; to: 0.8 0.8 0.8; dur: 350; easing: easeOutQuad; startEvents: claim"
        >
        </a-entity>

        <!-- RADAR RING pod pinom -->
        <a-ring
          id="claim-ring"
          position="0 -0.35 -1"
          radius-inner="0.1"
          radius-outer="0.11"
          material="color: #00fff2; opacity: 0.9; side: double"
          rotation="-90 0 0"
          animation__idle="property: rotation; to: -90 360 0; loop: true; dur: 2500; easing: linear"
          animation__claim="property: radius-outer; from: 0.11; to: 0.5; dur: 400; easing: easeOutQuad; startEvents: claim"
        >
        </a-ring>

        <!-- malo svetlobe -->
        <a-entity light="type: ambient; intensity: 0.9; color: #ffffff"></a-entity>
        <a-entity
          light="type: directional; intensity: 0.6"
          position="0.5 1 1"
        ></a-entity>
      </a-scene>

      <div class="ar-bottom" id="hint">
        Tapni na neon PIN, da prevzameš nagrado.
      </div>

      <div class="toast" id="toast"></div>
    </div>

    <script>
      // ===== helper za query parametre =====
      function getParam(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
      }

      const dropId = getParam("dropId") || "DEMO-DROP";
      const userId = getParam("userId") || "DEMO-USER";
      const userName = getParam("userName") || null;

      const titleLabel = document.getElementById("titleLabel");
      if (dropId && dropId !== "DEMO-DROP") {
        titleLabel.textContent = "AR prevzem • " + dropId;
      }

      const toastEl = document.getElementById("toast");
      const hintEl = document.getElementById("hint");
      const btnClose = document.getElementById("btnClose");

      function showToast(msg) {
        toastEl.textContent = msg;
        toastEl.classList.add("show");
        setTimeout(() => toastEl.classList.remove("show"), 2000);
      }

      // API = isti origin kot ar.html (moveserver.realdrophunt.com)
      const API = window.location.origin;

      // ==== ZAPRI GUMB – NAZAJ NA MOVEAPP ALI HISTORY.BACK ====
      btnClose.addEventListener("click", () => {
        if (window.history.length > 1) {
          window.history.back();
        } else {
          // direktno nazaj v app
          window.location.href = "https://moveapp.realdrophunt.com";
        }
      });

      // Uporabimo window.load, da je A-Frame scena sigurno inicializirana
      window.addEventListener("load", () => {
        const pin = document.querySelector("#claim-pin");
        const ring = document.querySelector("#claim-ring");

        if (!pin) return;

        let claimed = false;

        pin.addEventListener("click", async () => {
          if (claimed) return;
          claimed = true;

          // AR ANIMACIJA
          pin.emit("claim");
          if (ring) ring.emit("claim");

          showToast("Pošiljam prevzem ...");

          try {
            const res = await fetch(API + "/api/claims", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                drop_id: dropId,
                user_id: userId,
                user_name: userName,
                // za demo pošljemo brez lat/lng (backend razdalje ne bo preverjal)
                lat: null,
                lng: null,
                value: 1
              })
            });

            const data = await res.json();

            if (data.ok) {
              showToast("✅ Nagrada uspešno prevzeta");
              hintEl.textContent =
                "Prevzem je uspel. Lahko zapreš AR pogled z gumbom zgoraj.";
            } else {
              showToast("Napaka: " + (data.error || "unknown"));
              hintEl.textContent =
                "Prevzem ni uspel: " + (data.error || "neznana napaka");
            }
          } catch (e) {
            console.error(e);
            showToast("Napaka pri povezavi");
            hintEl.textContent = "Napaka pri povezavi s strežnikom.";
          }
        });
      });
    </script>
  </body>
</html>
